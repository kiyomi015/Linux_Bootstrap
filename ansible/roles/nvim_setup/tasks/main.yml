---
- name: Install Neovim tooling packages
  ansible.builtin.apt:
    name: "{{ nvim_packages }}"
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Ensure local bin exists
  ansible.builtin.file:
    path: "{{ bootstrap_home }}/.local/bin"
    state: directory
    owner: "{{ bootstrap_user }}"
    group: "{{ bootstrap_user }}"
    mode: "0755"

- name: Resolve neovim path
  ansible.builtin.command: "command -v nvim"
  register: nvim_path
  changed_when: false

- name: Create Neovim aliases for vim/vi
  ansible.builtin.file:
    src: "{{ nvim_path.stdout }}"
    dest: "{{ nvim_alias_dir }}/{{ item }}"
    state: link
    force: true
  become: true
  become_user: "{{ bootstrap_user }}"
  environment:
    HOME: "{{ bootstrap_home }}"
  loop: "{{ nvim_alias_names }}"
  when:
    - nvim_alias_enable
    - nvim_path.stdout | length > 0

- name: Check fdfind binary
  ansible.builtin.stat:
    path: /usr/bin/fdfind
  register: fdfind_bin

- name: Check fd binary
  ansible.builtin.stat:
    path: /usr/bin/fd
  register: fd_bin

- name: Link fd to fdfind for user
  ansible.builtin.file:
    src: /usr/bin/fdfind
    dest: "{{ fd_link_path }}"
    state: link
  become: true
  become_user: "{{ bootstrap_user }}"
  environment:
    HOME: "{{ bootstrap_home }}"
  when:
    - fd_link_enable
    - fdfind_bin.stat.exists
    - not fd_bin.stat.exists

- name: Ensure config directory exists
  ansible.builtin.file:
    path: "{{ bootstrap_home }}/.config"
    state: directory
    owner: "{{ bootstrap_user }}"
    group: "{{ bootstrap_user }}"
    mode: "0755"

- name: Check existing Neovim config
  ansible.builtin.stat:
    path: "{{ nvim_config_dir }}"
  register: nvim_config_stat

- name: Remove existing Neovim config when forced
  ansible.builtin.file:
    path: "{{ nvim_config_dir }}"
    state: absent
  when:
    - lazyvim_force
    - nvim_config_stat.stat.exists

- name: Install LazyVim starter
  ansible.builtin.git:
    repo: "{{ lazyvim_repo }}"
    dest: "{{ nvim_config_dir }}"
    version: HEAD
    update: true
  become: true
  become_user: "{{ bootstrap_user }}"
  environment:
    HOME: "{{ bootstrap_home }}"
  when: not nvim_config_stat.stat.exists or lazyvim_force

- name: Remove LazyVim git metadata
  ansible.builtin.file:
    path: "{{ nvim_config_dir }}/.git"
    state: absent
  when: lazyvim_remove_git
